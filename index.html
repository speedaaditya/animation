<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FrameSync - One Piece Video Analyzer</title>
    <style>
        :root {
            --strawhat-red: #c00a0a;
            --strawhat-yellow: #ffcc00;
            --nami-orange: #ff8c00;
            --zoro-green: #006400;
            --sanji-blue: #1e90ff;
            --brook-white: #f0f0f0;
            --dark-blue: #0a1a3c;
            --darker-blue: #050e1f;
            --deep-blue: #020811;
            --light: #e0e0e0;
            --gray: #5a6268;
            --success: #4cc9f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--deep-blue), var(--darker-blue));
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(192, 10, 10, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 204, 0, 0.05) 0%, transparent 20%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
            position: relative;
        }
        
        .strawhat-logo {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background: var(--strawhat-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 0 20px var(--strawhat-yellow);
            z-index: 2;
        }
        
        .strawhat-logo::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--strawhat-red);
            z-index: -1;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 800;
            background: linear-gradient(to right, var(--strawhat-yellow), var(--nami-orange));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin-top: 30px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: var(--strawhat-yellow);
            max-width: 600px;
            margin: 0 auto;
            font-style: italic;
            opacity: 0.8;
        }
        
        .card {
            background: rgba(10, 20, 40, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(192, 10, 10, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--strawhat-red), var(--strawhat-yellow));
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--strawhat-yellow);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed rgba(255, 204, 0, 0.3);
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(5, 14, 31, 0.5);
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, transparent, rgba(255, 204, 0, 0.1), transparent);
            z-index: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .upload-area:hover::before, .upload-area.dragover::before {
            opacity: 1;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--strawhat-yellow);
            background: rgba(255, 204, 0, 0.05);
        }
        
        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: var(--strawhat-yellow);
            position: relative;
            z-index: 1;
        }
        
        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--strawhat-yellow);
            position: relative;
            z-index: 1;
        }
        
        .upload-subtext {
            color: var(--strawhat-yellow);
            font-size: 0.95rem;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-label {
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--strawhat-yellow);
        }
        
        select, button, input {
            padding: 14px 16px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        select, input {
            background: rgba(20, 30, 48, 0.8);
            color: var(--light);
            border: 1px solid rgba(255, 204, 0, 0.3);
            cursor: pointer;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--strawhat-yellow);
            box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.3);
        }
        
        button {
            background: linear-gradient(to bottom, var(--strawhat-red), #8a0606);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px solid rgba(255, 204, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #d00b0b, var(--strawhat-red));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(192, 10, 10, 0.5);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button:disabled::before {
            display: none;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 204, 0, 0.2);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--strawhat-red), var(--strawhat-yellow));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .status {
            text-align: center;
            font-size: 0.95rem;
            color: var(--strawhat-yellow);
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: #ff6b6b;
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .preview-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 204, 0, 0.3);
        }
        
        .preview-container video, .preview-container img {
            width: 100%;
            display: block;
        }
        
        .preview-label {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(10, 20, 40, 0.9);
            padding: 10px 15px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--strawhat-yellow);
            border-bottom: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .frame-info {
            background: rgba(20, 30, 48, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            border: 1px solid rgba(255, 204, 0, 0.2);
        }
        
        .frame-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--strawhat-yellow);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--strawhat-yellow);
            margin-top: 5px;
            opacity: 0.8;
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            background: rgba(255, 204, 0, 0.1);
            border: 1px solid rgba(255, 204, 0, 0.3);
            color: var(--strawhat-yellow);
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: var(--strawhat-red);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(192, 10, 10, 0.7);
        }
        
        .nav-btn:active {
            transform: scale(1);
        }
        
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .thumbnails-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 204, 0, 0.2);
        }
        
        .thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }
        
        .thumbnail {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            aspect-ratio: 16/9;
        }
        
        .thumbnail:hover {
            transform: scale(1.05);
            border-color: var(--strawhat-yellow);
        }
        
        .thumbnail.active {
            border-color: var(--strawhat-red);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(192, 10, 10, 0.7);
        }
        
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .thumbnail-time {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 20, 40, 0.9);
            padding: 4px;
            font-size: 0.7rem;
            text-align: center;
            color: var(--strawhat-yellow);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--strawhat-yellow);
            opacity: 0.7;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .firebase-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 204, 0, 0.2);
        }
        
        .firebase-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .firebase-controls button {
            flex: 1;
        }
        
        .session-info {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .session-id {
            background: rgba(20, 30, 48, 0.8);
            padding: 12px 16px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            min-height: 48px;
            display: flex;
            align-items: center;
            color: var(--strawhat-yellow);
            border: 1px solid rgba(255, 204, 0, 0.3);
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--strawhat-yellow);
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gray);
            transition: background 0.3s ease;
        }
        
        .sync-dot.synced {
            background: var(--strawhat-yellow);
            box-shadow: 0 0 10px var(--strawhat-yellow);
        }
        
        .video-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(20, 30, 48, 0.8);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--strawhat-yellow);
            border: 1px solid rgba(255, 204, 0, 0.2);
        }
        
        /* Preview controls for the GIF-like video */
        .preview-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .preview-controls button {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        
        .one-piece-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            opacity: 0.05;
            pointer-events: none;
        }
        
        .decoration-1 {
            top: 10px;
            right: 10px;
            background: radial-gradient(circle, var(--strawhat-red) 0%, transparent 70%);
        }
        
        .decoration-2 {
            bottom: 10px;
            left: 10px;
            background: radial-gradient(circle, var(--strawhat-yellow) 0%, transparent 70%);
        }
        
        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--strawhat-yellow);
            font-size: 1.2rem;
            text-align: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
        }
        
        @media (max-width: 1024px) {
            .preview-section {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .thumbnails-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .session-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .session-id {
                min-height: 44px;
                font-size: 0.9rem;
            }
            
            .strawhat-logo {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .strawhat-logo::before {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="strawhat-logo">üè¥‚Äç‚ò†Ô∏è</div>
            <h1>FrameSync - One Piece Edition</h1>
            <p class="subtitle">Multi-device video frame analyzer with real-time synchronization - Set sail for perfect frames!</p>
        </header>
        
        <div class="card">
            <div class="one-piece-decoration decoration-1"></div>
            <div class="one-piece-decoration decoration-2"></div>
            <h2 class="card-title"><i>üìÅ</i> Upload Video</h2>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üè¥‚Äç‚ò†Ô∏è</div>
                <div class="upload-text">Drop your video treasure here</div>
                <div class="upload-subtext">or click to browse (MP4, WebM, MOV)</div>
                <input type="file" id="file-input" accept=".mp4,.webm,.mov" style="display: none;">
            </div>
            
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">Frame Interval</div>
                    <select id="frame-interval">
                        <option value="0.033">0.033s (30fps)</option>
                        <option value="0.041">0.041s (24fps)</option>
                        <option value="0.1">0.1s (10fps)</option>
                        <option value="0.25">0.25s (4fps)</option>
                        <option value="0.5" selected>0.5s (2fps)</option>
                        <option value="1">1s (1fps)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">Frame Quality</div>
                    <select id="frame-quality">
                        <option value="1">High Quality</option>
                        <option value="0.8" selected>Balanced</option>
                        <option value="0.6">Optimized</option>
                        <option value="0.4">Low Quality</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">&nbsp;</div>
                    <button id="extract-btn" disabled>
                        <i>üîç</i> Extract Frames
                    </button>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <div class="status" id="status">Select a video file to begin your adventure</div>
            </div>
            
            <div class="error-message" id="error-message"></div>
            
            <div class="firebase-section">
                <h2 class="card-title"><i>üåê</i> Crew Sync</h2>
                <div class="session-info">
                    <div class="control-label">Session ID:</div>
                    <div class="session-id" id="session-id">Not connected</div>
                    <button id="copy-session-btn">
                        <i>üìã</i> Copy
                    </button>
                </div>
                <div class="firebase-controls">
                    <button id="new-session-btn">
                        <i>üÜï</i> New Voyage
                    </button>
                    <button id="join-session-btn">
                        <i>üîó</i> Join Crew
                    </button>
                </div>
                <div class="sync-indicator">
                    <div class="sync-dot" id="sync-dot"></div>
                    <span id="sync-status">Not connected to Firebase</span>
                </div>
            </div>
        </div>

        <div class="preview-section">
            <div class="card">
                <h2 class="card-title"><i>üé¨</i> Video Preview</h2>
                <div class="preview-container">
                    <div class="preview-label">Looping Preview - GIF Style</div>
                    <div class="video-loading" id="video-loading">Loading video...</div>
                    <video id="video-preview" muted loop playsinline></video>
                </div>
                <!-- Preview controls -->
                <div class="preview-controls">
                    <button id="play-preview">
                        <i>‚ñ∂Ô∏è</i> Play
                    </button>
                    <button id="pause-preview">
                        <i>‚è∏Ô∏è</i> Pause
                    </button>
                    <button id="restart-preview">
                        <i>‚èÆÔ∏è</i> Restart
                    </button>
                </div>
                <div class="video-info" id="video-info">
                    No video loaded. Upload a video or join a crew with an existing video.
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i>üñºÔ∏è</i> Current Frame</h2>
                <div class="preview-container">
                    <div class="preview-label">Selected Frame</div>
                    <img id="current-frame-img" src="" alt="Current frame" style="display: none;">
                    <div id="no-frame" class="empty-state">
                        <i>üñºÔ∏è</i>
                        <div>No frame selected</div>
                    </div>
                </div>
                
                <div class="frame-info">
                    <div class="frame-stats">
                        <div class="stat">
                            <div class="stat-value" id="current-frame-index">0</div>
                            <div class="stat-label">Frame</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="total-frames">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="current-time">0.00</div>
                            <div class="stat-label">Seconds</div>
                        </div>
                    </div>
                    
                    <div class="navigation">
                        <button id="first-frame" class="nav-btn" disabled>‚èÆ</button>
                        <button id="prev-frame" class="nav-btn" disabled>‚óÄ</button>
                        <button id="next-frame" class="nav-btn" disabled>‚ñ∂</button>
                        <button id="last-frame" class="nav-btn" disabled>‚è≠</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title"><i>üì∏</i> Frame Thumbnails</h2>
            <div class="thumbnails-container" id="thumbnails-container">
                <div class="empty-state">
                    <i>üì∏</i>
                    <div>Frames will appear here after extraction</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBJW3NTVkqOXErSNOXzwXmXr1XMy--2jsA",
  authDomain: "animation-f8b6a.firebaseapp.com",
  projectId: "animation-f8b6a",
  storageBucket: "animation-f8b6a.firebasestorage.app",
  messagingSenderId: "66022891515",
  appId: "1:66022891515:web:f061b4aa0e235ac7c5355e",
  measurementId: "G-GHNZJ0L46G"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const extractBtn = document.getElementById('extract-btn');
            const videoPreview = document.getElementById('video-preview');
            const videoInfo = document.getElementById('video-info');
            const currentFrameImg = document.getElementById('current-frame-img');
            const noFrameMsg = document.getElementById('no-frame');
            const currentFrameIndex = document.getElementById('current-frame-index');
            const totalFrames = document.getElementById('total-frames');
            const currentTime = document.getElementById('current-time');
            const progressBar = document.getElementById('progress-bar');
            const status = document.getElementById('status');
            const errorMessage = document.getElementById('error-message');
            const thumbnailsContainer = document.getElementById('thumbnails-container');
            const videoLoading = document.getElementById('video-loading');
            
            // Preview control buttons
            const playPreviewBtn = document.getElementById('play-preview');
            const pausePreviewBtn = document.getElementById('pause-preview');
            const restartPreviewBtn = document.getElementById('restart-preview');
            
            // Firebase elements
            const sessionIdElement = document.getElementById('session-id');
            const copySessionBtn = document.getElementById('copy-session-btn');
            const newSessionBtn = document.getElementById('new-session-btn');
            const joinSessionBtn = document.getElementById('join-session-btn');
            const syncDot = document.getElementById('sync-dot');
            const syncStatus = document.getElementById('sync-status');
            
            // Navigation buttons
            const firstFrameBtn = document.getElementById('first-frame');
            const prevFrameBtn = document.getElementById('prev-frame');
            const nextFrameBtn = document.getElementById('next-frame');
            const lastFrameBtn = document.getElementById('last-frame');
            
            let frames = [];
            let currentFrame = 0;
            let isProcessing = false;
            let currentSessionId = null;
            let unsubscribeFromFrames = null;
            let currentVideoFile = null;
            let isHost = false;

            // Firebase Functions
            function generateSessionId() {
                return Math.random().toString(36).substring(2, 10) + Math.random().toString(36).substring(2, 10);
            }

            function createNewSession() {
                currentSessionId = generateSessionId();
                sessionIdElement.textContent = currentSessionId;
                syncStatus.textContent = "Creating new voyage...";
                isHost = true;
                
                // Enable upload for host
                uploadArea.style.opacity = "1";
                uploadArea.style.cursor = "pointer";
                uploadArea.title = "Drop your video treasure here or click to browse";
                
                // Clear any existing frames
                frames = [];
                updateThumbnails();
                resetFrameNavigation();
                
                // Set up real-time listener for this session
                setupFrameListener();
                
                syncDot.classList.add('synced');
                syncStatus.textContent = "Connected to voyage - Ready for video upload";
            }

            function joinSession() {
                const sessionId = prompt("Enter the Crew ID to join:");
                if (sessionId && sessionId.trim() !== '') {
                    currentSessionId = sessionId.trim();
                    sessionIdElement.textContent = currentSessionId;
                    syncStatus.textContent = "Joining crew...";
                    isHost = false;
                    
                    // Disable upload for joined devices (only host can upload)
                    uploadArea.style.opacity = "0.6";
                    uploadArea.style.cursor = "not-allowed";
                    uploadArea.title = "Only the crew captain can upload videos";
                    
                    // Set up real-time listener for this session
                    setupFrameListener();
                    
                    syncDot.classList.add('synced');
                    syncStatus.textContent = "Connected to crew - Waiting for video";
                }
            }

            function setupFrameListener() {
                // Unsubscribe from previous listener if exists
                if (unsubscribeFromFrames) {
                    unsubscribeFromFrames();
                }
                
                // Set up real-time listener for frames in this session
                unsubscribeFromFrames = db.collection('sessions').doc(currentSessionId)
                    .collection('frames')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snapshot => {
                        frames = [];
                        snapshot.forEach(doc => {
                            const frameData = doc.data();
                            frames.push({
                                id: doc.id,
                                time: frameData.time,
                                dataUrl: frameData.dataUrl,
                                timestamp: frameData.timestamp
                            });
                        });
                        
                        updateThumbnails();
                        
                        if (frames.length > 0 && currentFrame >= frames.length) {
                            selectFrame(frames.length - 1);
                        } else if (frames.length > 0 && currentFrame === 0) {
                            selectFrame(0);
                        }
                        
                        status.textContent = `Synced ${frames.length} frames from Firebase`;
                    }, error => {
                        console.error("Error listening to frames:", error);
                        syncStatus.textContent = "Error connecting to crew";
                        syncDot.classList.remove('synced');
                    });

                // Also listen for video metadata in the session document
                db.collection('sessions').doc(currentSessionId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const sessionData = doc.data();
                            if (sessionData.videoUrl) {
                                // Load the video from Firebase Storage
                                loadVideoFromUrl(sessionData.videoUrl, sessionData.videoName);
                            }
                        }
                    });
            }

            async function loadVideoFromUrl(videoUrl, videoName) {
                try {
                    status.textContent = "Loading video from crew...";
                    videoLoading.style.display = 'block';
                    
                    // Reset video element
                    videoPreview.src = '';
                    videoPreview.load();
                    
                    // Set the video source
                    videoPreview.src = videoUrl;
                    
                    // Wait for video to load
                    await new Promise((resolve, reject) => {
                        const onLoaded = () => {
                            videoPreview.removeEventListener('loadeddata', onLoaded);
                            videoPreview.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            videoPreview.removeEventListener('loadeddata', onLoaded);
                            videoPreview.removeEventListener('error', onError);
                            reject(e);
                        };
                        
                        videoPreview.addEventListener('loadeddata', onLoaded);
                        videoPreview.addEventListener('error', onError);
                        
                        // If video is already loaded, resolve immediately
                        if (videoPreview.readyState >= 3) {
                            resolve();
                        } else {
                            // Set a timeout in case loading takes too long
                            setTimeout(() => {
                                if (videoPreview.readyState < 3) {
                                    reject(new Error('Video loading timeout'));
                                }
                            }, 10000);
                        }
                    });
                    
                    videoLoading.style.display = 'none';
                    
                    // Enable the preview controls
                    playPreviewBtn.disabled = false;
                    pausePreviewBtn.disabled = false;
                    restartPreviewBtn.disabled = false;
                    
                    // Try to auto-play the video for the GIF-like experience
                    const playPromise = videoPreview.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            status.textContent = "Video loaded and playing";
                        }).catch(error => {
                            console.log("Autoplay prevented, user interaction required");
                            status.textContent = "Video loaded - Click play to start";
                        });
                    }
                    
                    videoInfo.innerHTML = `
                        <strong>Video:</strong> ${videoName || 'Crew Video'}<br>
                        <strong>Duration:</strong> ${formatTime(videoPreview.duration)}<br>
                        <strong>Size:</strong> ${videoPreview.videoWidth}√ó${videoPreview.videoHeight}
                    `;
                    
                    status.textContent = "Video loaded from crew";
                    extractBtn.disabled = false;
                    
                } catch (error) {
                    console.error("Error loading video:", error);
                    videoLoading.style.display = 'none';
                    showError("Failed to load video from crew: " + error.message);
                }
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            async function saveFrameToFirebase(frameData) {
                if (!currentSessionId) return null;
                
                try {
                    const docRef = await db.collection('sessions').doc(currentSessionId)
                        .collection('frames')
                        .add({
                            time: frameData.time,
                            dataUrl: frameData.dataUrl,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    return docRef.id;
                } catch (error) {
                    console.error("Error saving frame to Firebase:", error);
                    return null;
                }
            }

            async function saveVideoToFirebase(file) {
                if (!currentSessionId) return null;
                
                try {
                    // Upload video to Firebase Storage
                    const videoRef = storage.ref().child(`sessions/${currentSessionId}/video`);
                    const snapshot = await videoRef.put(file);
                    const videoUrl = await snapshot.ref.getDownloadURL();
                    
                    // Save video metadata to Firestore
                    await db.collection('sessions').doc(currentSessionId).set({
                        videoUrl: videoUrl,
                        videoName: file.name,
                        videoSize: file.size,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    return videoUrl;
                } catch (error) {
                    console.error("Error saving video to Firebase:", error);
                    return null;
                }
            }

            function updateThumbnails() {
                if (frames.length === 0) {
                    thumbnailsContainer.innerHTML = '<div class="empty-state"><i>üì∏</i><div>No frames in this crew</div></div>';
                    return;
                }
                
                thumbnailsContainer.innerHTML = '';
                const thumbnailsGrid = document.createElement('div');
                thumbnailsGrid.className = 'thumbnails-grid';
                
                frames.forEach((frame, index) => {
                    const thumb = document.createElement('div');
                    thumb.className = `thumbnail ${index === currentFrame ? 'active' : ''}`;
                    thumb.innerHTML = `
                        <img src="${frame.dataUrl}" alt="Frame at ${frame.time.toFixed(2)}s">
                        <div class="thumbnail-time">${frame.time.toFixed(2)}s</div>
                    `;
                    thumb.addEventListener('click', () => selectFrame(index));
                    thumbnailsGrid.appendChild(thumb);
                });
                
                thumbnailsContainer.appendChild(thumbnailsGrid);
            }

            // Preview control functions
            function playPreview() {
                if (videoPreview.src) {
                    videoPreview.play().then(() => {
                        status.textContent = "Video playing";
                    }).catch(e => {
                        showError("Could not play video: " + e.message);
                    });
                }
            }
            
            function pausePreview() {
                if (videoPreview.src) {
                    videoPreview.pause();
                    status.textContent = "Video paused";
                }
            }
            
            function restartPreview() {
                if (videoPreview.src) {
                    videoPreview.currentTime = 0;
                    videoPreview.play().then(() => {
                        status.textContent = "Video restarted";
                    }).catch(e => {
                        showError("Could not restart video: " + e.message);
                    });
                }
            }

            // File upload handling
            uploadArea.addEventListener('click', () => {
                if (!isHost && currentSessionId) {
                    showError("Only the crew captain can upload videos");
                    return;
                }
                fileInput.click();
            });
            
            ['dragover', 'dragenter'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    if (!isHost && currentSessionId) return;
                    uploadArea.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(event => {
                uploadArea.addEventListener(event, (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    if (event === 'drop' && e.dataTransfer.files.length > 0) {
                        if (!isHost && currentSessionId) {
                            showError("Only the crew captain can upload videos");
                            return;
                        }
                        handleFileSelect(e.dataTransfer.files[0]);
                    }
                });
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    if (!isHost && currentSessionId) {
                        showError("Only the crew captain can upload videos");
                        return;
                    }
                    handleFileSelect(e.target.files[0]);
                }
            });

            function handleFileSelect(file) {
                if (!file.type.includes('video/') && !file.name.match(/\.(mp4|webm|mov)$/i)) {
                    showError('Please select a valid video file (MP4, WebM, or MOV)');
                    return;
                }
                
                currentVideoFile = file;
                const objectUrl = URL.createObjectURL(file);
                videoPreview.src = objectUrl;
                
                // Enable preview controls
                playPreviewBtn.disabled = false;
                pausePreviewBtn.disabled = false;
                restartPreviewBtn.disabled = false;
                
                // Auto-play the video
                videoPreview.play().then(() => {
                    status.textContent = "Video loaded and playing";
                }).catch(e => {
                    console.log("Autoplay prevented, user interaction required");
                    status.textContent = "Video loaded - Click play to start";
                });
                
                videoInfo.innerHTML = `
                    <strong>Video:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${formatFileSize(file.size)}<br>
                    <strong>Type:</strong> ${file.type || 'Unknown'}
                `;
                
                extractBtn.disabled = false;
                status.textContent = 'Ready to extract frames';
                hideError();
                
                // If we're in a session, upload the video to Firebase
                if (currentSessionId && isHost) {
                    status.textContent = 'Uploading video to crew...';
                    saveVideoToFirebase(file).then(videoUrl => {
                        if (videoUrl) {
                            status.textContent = 'Video uploaded to crew';
                        }
                    });
                }
                
                // Reset previous frames
                frames = [];
                updateThumbnails();
                resetFrameNavigation();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Extract frames
            extractBtn.addEventListener('click', async function() {
                if (isProcessing) return;
                
                if (!currentSessionId) {
                    showError('Please create or join a crew first to enable cross-device sync');
                    return;
                }
                
                frames = [];
                updateThumbnails();
                progressBar.style.width = '0%';
                hideError();
                isProcessing = true;
                extractBtn.disabled = true;
                extractBtn.innerHTML = '<i>‚è≥</i> Processing...';
                resetFrameNavigation();
                
                try {
                    if (videoPreview.readyState < 2) {
                        await new Promise((resolve, reject) => {
                            videoPreview.addEventListener('loadedmetadata', resolve);
                            videoPreview.addEventListener('error', reject);
                            setTimeout(() => reject(new Error('Video loading timeout')), 10000);
                        });
                    }
                    
                    const frameInterval = parseFloat(document.getElementById('frame-interval').value);
                    const quality = parseFloat(document.getElementById('frame-quality').value);
                    const duration = videoPreview.duration;
                    const totalFramesCount = Math.ceil(duration / frameInterval);
                    
                    status.textContent = `Extracting ${totalFramesCount} frames...`;
                    
                    for (let i = 0; i < totalFramesCount; i++) {
                        const time = i * frameInterval;
                        videoPreview.currentTime = time;
                        
                        await new Promise(resolve => {
                            videoPreview.addEventListener('seeked', function seekHandler() {
                                videoPreview.removeEventListener('seeked', seekHandler);
                                
                                const canvas = document.createElement('canvas');
                                canvas.width = Math.max(1, videoPreview.videoWidth * quality);
                                canvas.height = Math.max(1, videoPreview.videoHeight * quality);
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
                                
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                                
                                // Save frame to Firebase
                                saveFrameToFirebase({ time: time, dataUrl: dataUrl });
                                
                                // Update progress
                                const progress = ((i + 1) / totalFramesCount) * 100;
                                progressBar.style.width = `${progress}%`;
                                status.textContent = `Extracted ${i + 1} of ${totalFramesCount} frames`;
                                
                                resolve();
                            });
                        });
                        
                        // Allow UI to update
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    
                    status.textContent = `Successfully extracted and synced ${totalFramesCount} frames`;
                    
                } catch (err) {
                    showError(`Failed to extract frames: ${err.message}`);
                } finally {
                    isProcessing = false;
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<i>üîç</i> Extract Frames';
                }
            });

            // Frame navigation functions
            function selectFrame(index) {
                if (!frames.length || index < 0 || index >= frames.length) return;
                
                currentFrame = index;
                const frame = frames[currentFrame];
                
                currentFrameImg.src = frame.dataUrl;
                currentFrameImg.style.display = 'block';
                noFrameMsg.style.display = 'none';
                
                currentFrameIndex.textContent = currentFrame + 1;
                totalFrames.textContent = frames.length;
                currentTime.textContent = frame.time.toFixed(2);
                
                // Update active thumbnail
                updateThumbnails();
                
                updateNavigationButtons();
            }

            function goToFirstFrame() { selectFrame(0); }
            function goToPrevFrame() { if (currentFrame > 0) selectFrame(currentFrame - 1); }
            function goToNextFrame() { if (currentFrame < frames.length - 1) selectFrame(currentFrame + 1); }
            function goToLastFrame() { selectFrame(frames.length - 1); }

            function updateNavigationButtons() {
                const hasFrames = frames.length > 0;
                firstFrameBtn.disabled = !hasFrames || currentFrame === 0;
                prevFrameBtn.disabled = !hasFrames || currentFrame === 0;
                nextFrameBtn.disabled = !hasFrames || currentFrame === frames.length - 1;
                lastFrameBtn.disabled = !hasFrames || currentFrame === frames.length - 1;
            }

            function enableFrameNavigation() {
                firstFrameBtn.addEventListener('click', goToFirstFrame);
                prevFrameBtn.addEventListener('click', goToPrevFrame);
                nextFrameBtn.addEventListener('click', goToNextFrame);
                lastFrameBtn.addEventListener('click', goToLastFrame);
                updateNavigationButtons();
            }

            function resetFrameNavigation() {
                currentFrame = 0;
                currentFrameImg.style.display = 'none';
                noFrameMsg.style.display = 'block';
                currentFrameIndex.textContent = '0';
                totalFrames.textContent = '0';
                currentTime.textContent = '0.00';
                updateNavigationButtons();
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            function hideError() {
                errorMessage.style.display = 'none';
            }

            // Preview control event listeners
            playPreviewBtn.addEventListener('click', playPreview);
            pausePreviewBtn.addEventListener('click', pausePreview);
            restartPreviewBtn.addEventListener('click', restartPreview);

            // Firebase button event listeners
            newSessionBtn.addEventListener('click', createNewSession);
            joinSessionBtn.addEventListener('click', joinSession);
            copySessionBtn.addEventListener('click', () => {
                if (currentSessionId) {
                    navigator.clipboard.writeText(currentSessionId)
                        .then(() => {
                            const originalText = copySessionBtn.innerHTML;
                            copySessionBtn.innerHTML = '<i>‚úÖ</i> Copied!';
                            setTimeout(() => {
                                copySessionBtn.innerHTML = originalText;
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy session ID: ', err);
                        });
                }
            });

            // Initialize frame navigation
            enableFrameNavigation();
            
            // Initialize preview controls as disabled until video is loaded
            playPreviewBtn.disabled = true;
            pausePreviewBtn.disabled = true;
            restartPreviewBtn.disabled = true;
        });
    </script>
</body>
    </html>
